import numpy as np
import time

from _util import physical_constants
p = physical_constants()

import WRSpice

#%%

# tempCirFile only netlist
# export your netlist to a cir file using 'deck' command in xic
# open the cir file and remove all lines except the netlist lines
# replace all values by Params, you want to sweep, with white space around
# Component names don't need any changes
# VERY IMPORTTANT Leave a blank line in the start and end of the  cir file

#%%
Ma = np.sqrt(400*12.5) # pH
Mp = 77.5 # Ph

num_steps = 50 # for activity flux

max_flux = p['Phi0__pH_ns']/2
_fr = max_flux/num_steps # flux_resolution
_fr_0 = max_flux/200 # flux_resolution of first onset point

# dendritic series bias current
dIb = 5
Ib_vec = np.arange(115,140+dIb,dIb) # uA

# plasticity flux biases
Phi_p_list = [-1033.916875,-982.221031,-930.525188,-878.829344,-827.133500,-775.437656,-723.741813,-672.045969,-620.350125,-568.654281,-516.958438,-465.262594,-413.566750,-361.870906,-310.175063,-258.479219,-206.783375,-155.087531,-103.391688,-51.695844,0.000000,51.695844,103.391688,155.087531,206.783375,258.479219,310.175063,361.870906,413.566750,465.262594,516.958438,568.654281,620.350125,672.045969,723.741813,775.437656,827.133500,878.829344,930.525188,982.221031,1033.916875]                    

# activity flux 
Phi_a_on__array = [[982.410745,975.587731,967.007273,957.599783,947.675398,937.337496,926.689458,915.834662,904.773108,893.504796,882.133104,870.554655,858.976206,847.190999,835.405791,823.413826,811.421861,799.326516,787.127793,775.032449,762.730346,750.221486,737.816004,725.203765,712.591526,699.875907,687.056910,674.237912,661.315536,648.289781,635.160646,621.928133,608.695619,595.359727,581.817076,568.274426,554.628396,540.878988,526.922821,512.966655,498.803730],[881.719588,901.568359,898.053472,890.713562,881.719588,872.001961,861.870818,851.326159,840.678121,829.616567,818.348254,806.769805,795.191356,783.509527,771.620941,759.835734,747.740390,735.541666,723.342943,710.937461,698.428601,685.919741,673.307501,660.591883,647.772885,634.850509,621.824754,608.695619,595.463106,582.127213,568.791321,555.248670,541.602641,527.853232,513.897066,499.837520,485.674596,471.408292,456.831851,442.152032,427.368833],[700.702939,762.833725,806.873184,817.934738,812.662409,804.598846,795.398114,785.473729,775.032449,764.281031,753.219477,741.847786,730.372716,718.690887,706.802301,694.810336,682.714991,670.412889,658.007408,645.498547,632.886308,620.170689,607.351692,594.325937,581.300181,568.067668,554.731775,541.292504,527.646474,513.897066,500.044278,486.088112,471.821808,457.555504,442.979064,428.299244,413.309288,398.112573,382.709100,366.995491,350.971744],[481.539435,560.210863,631.232244,690.261659,727.684861,731.923401,725.513902,716.933444,707.319196,697.084674,686.333257,675.168324,663.796632,652.218183,640.329597,628.234252,616.035529,603.630048,591.121187,578.405569,565.483192,552.457437,539.328303,525.992410,512.553139,498.907109,485.157701,471.098155,457.038609,442.668927,428.092486,413.412667,398.319331,383.122616,367.615765,351.695397,335.568271,318.924250,301.866713,284.292281,266.097575],[236.427799,325.540507,410.104538,488.155692,557.626388,613.451054,643.741104,643.430967,636.091057,626.993704,616.965940,606.214523,595.049590,583.471140,571.685933,559.487210,547.185107,534.572868,521.753871,508.728115,495.495602,482.159709,468.513680,454.660892,440.601347,426.335043,411.861981,397.182162,382.088826,366.788732,351.178502,335.258134,318.820871,301.970092,284.602418,266.614470,247.902869,228.157478,207.274918,184.841672,160.030710],[0.000000,60.890238,156.825960,247.696111,332.570280,410.414675,478.541444,531.161361,554.525017,551.527026,543.463463,533.745836,523.097798,511.726106,499.940899,487.742176,475.129936,462.310939,449.078426,435.639154,421.889746,407.830200,393.563896,378.884077,363.997499,348.697405,332.983796,316.856670,300.316028,283.155112,265.477301,246.972458,227.537204,206.964781,184.738293,160.237468,131.911619,95.625586,0.000000,0.000000,0.000000]]
# positive current with Ma positive


#%%
rate = WRSpice.WRSpice(tempCirFile = 'dend__4jj__one_bias__plasticity__mid_betaL__cnst_drv', OutDatFile = 'dend_4jj_one_bias_plstc_cnst_drv_seek_dur_') # no file extentions
rate.pathWRSSpice = '/raid/home/local/xictools/wrspice.current/bin/wrspice'  # for running on grumpy
# rate.pathWRSSpice='C:/usr/local/xictools/wrspice/bin/wrspice.bat' # for local computer

rate.save = 'v(4)' # list all vectors you want to save
rate.pathCir = ''


FileFormat = 'Ib{:06.2f}uA_Ip{:09.6f}uA_Ia{:09.6f}'

for qq in range(len(Ib_vec)):
    Ib = Ib_vec[qq]
    for ii in range(len(Phi_p_list)):
        Phi_a_on = Phi_a_on__array[qq][ii]
        Phi_a_vec = np.append( np.insert( np.arange(Phi_a_on,max_flux,_fr) ,0,Phi_a_on-_fr_0 ) , max_flux ) 
        # print('Phi_a_vec = {}'.format(Phi_a_vec))
        # time.sleep(1)
        
        for jj in range(len(Phi_a_vec)):
        
            print('qq = {} of {}; ii = {} of {}; jj = {} of {}'.format(qq+1,len(Ib_vec),ii+1,len(Phi_p_list),jj+1,len(Phi_a_vec)))
                
            Ia = Phi_a_vec[jj]/Ma
            Ip = Phi_p_list[ii]/Mp
            FilePrefix = FileFormat.format(Ib,Ip,Ia)
            rate.FilePrefix = FilePrefix
                        
            Params = {          
            'Ip':'{:9.6f}u'.format(np.round(Ip,6)),
            'Ib':'{:6.2f}u'.format(np.round(Ib,2)),
            'Ia':'{:9.6f}u'.format(Ia),
            'Ldi':'77.5n'
            }
        
            rate.Params = Params
            rate.stepTran = '10p'
            rate.stopTran = '250n'
            rate.doAll()
